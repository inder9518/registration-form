<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Events</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 0; text-align: center; }
  h1 { margin: 20px 0; }
  .top-btn { display: block; width: 200px; margin: 20px auto; padding: 10px; background: #4facfe; color: white; border: none; border-radius: 8px; text-align: center; text-decoration: none; font-weight: bold; }
  .top-btn:hover { background: #007bff; }
  .container { width: 90%; margin: auto; }
  table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0px 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
  th { background: #4facfe; color: white; }
  button { padding: 6px 12px; border: none; background: #4facfe; color: white; font-size: 14px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
  button:hover { background: #007bff; }
  .create-section { background: white; padding: 15px; margin: 20px auto; border-radius: 10px; width: 90%; box-shadow: 0px 4px 20px rgba(0,0,0,0.1); }
  .data-table-container { margin-top: 15px; }
  .download-btn { background: #28a745; margin-bottom: 10px; }
  .download-btn:hover { background: #218838; }
</style>
</head>
<body>

<!-- Button to go to Registration Page -->
<a href="registration.html" class="top-btn">Go to Registration Page</a>

<h1>Admin - Manage Events</h1>

<div class="create-section">
  <input type="text" id="eventName" placeholder="Event Name">
  <input type="date" id="eventDate">
  <button onclick="addEvent()">Add Event</button>
</div>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Event Name</th>
        <th>Event Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="eventTable"></tbody>
  </table>
</div>

<script>
function getEvents(){ return JSON.parse(localStorage.getItem("events"))||[]; }
function saveEvents(events){ localStorage.setItem("events", JSON.stringify(events)); }
function getRegistrations(){ return JSON.parse(localStorage.getItem("registrations"))||[]; }

function addEvent(){
  const name=document.getElementById("eventName").value.trim();
  const date=document.getElementById("eventDate").value;
  if(!name||!date){ alert("Enter Event Name & Date"); return; }
  const events=getEvents();
  events.push({name,date});
  saveEvents(events);
  displayEvents();
  document.getElementById("eventName").value="";
  document.getElementById("eventDate").value="";
}

function editEvent(index){
  const events=getEvents();
  const newName=prompt("Edit Event Name:",events[index].name);
  const newDate=prompt("Edit Event Date:",events[index].date);
  if(newName && newDate){
    events[index]={name:newName.trim(),date:newDate};
    saveEvents(events);
    displayEvents();
  }
}

function deleteEvent(index){
  if(!confirm("Delete this event?")) return;
  let events=getEvents();
  events.splice(index,1);
  saveEvents(events);
  displayEvents();
}

function displayEvents(){
  const events=getEvents();
  const table=document.getElementById("eventTable");
  table.innerHTML="";
  events.forEach((event,idx)=>{
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${event.name}</td>
      <td>${event.date}</td>
      <td>
        <button onclick="showRegistrations(${idx},this)">Show Registrations</button>
        <button onclick="editEvent(${idx})">Edit Event</button>
        <button onclick="deleteEvent(${idx})">Delete Event</button>
      </td>
    `;
    table.appendChild(row);
  });
}

function showRegistrations(eventIndex,btn){
  const existing=btn.closest("tr").nextElementSibling;
  if(existing && existing.classList.contains("data-row")) { existing.remove(); return; }

  const registrations=getRegistrations().filter(r=>r.eventIndex==eventIndex);
  const events=getEvents();
  const eventName=events[eventIndex].name;

  const row=document.createElement("tr");
  row.classList.add("data-row");

  let tableHTML=`<td colspan="3">
    <div class="data-table-container">
      <h3>${eventName} - Total Registrations: ${registrations.length}</h3>
      <button class="download-btn" onclick="downloadCSV('${eventName}',${eventIndex})">Download Excel</button>
      <table border="1" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Phone</th><th>Gender</th><th>Race</th><th>DOB</th>
          </tr>
        </thead>
        <tbody>
          ${registrations.map(r=>`
            <tr>
              <td>${r.name}</td>
              <td>${r.email}</td>
              <td>${r.phone}</td>
              <td>${r.gender}</td>
              <td>${r.race}</td>
              <td>${r.dob}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  </td>`;

  row.innerHTML=tableHTML;
  btn.closest("tr").after(row);
}

function downloadCSV(eventName,eventIndex){
  const regs=getRegistrations().filter(r=>r.eventIndex==eventIndex);
  if(!regs.length){ alert("No data"); return; }
  const header=["Name","Email","Phone","Gender","Race","DOB"];
  const rows=regs.map(r=>[r.name,r.email,r.phone,r.gender,r.race,r.dob]);
  const csvContent=[header,...rows].map(e=>e.join(",")).join("\n");

  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=`${eventName}.csv`;
  link.click();
}

displayEvents();
</script>
</body>
</html>
