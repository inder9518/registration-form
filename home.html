<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Events</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f4f9;margin:0;padding:0;text-align:center;}
h1{margin:20px 0;}
.top-btn{display:block;width:200px;margin:10px auto;padding:10px;background:#4facfe;color:white;text-decoration:none;border-radius:8px;text-align:center;font-weight:bold;}
.top-btn:hover{background:#007bff;}
.filter-section,.create-section{background:white;padding:15px;margin:20px auto;border-radius:10px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
.container{width:90%;margin:auto;}
table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.1);margin-bottom:20px;}
th,td{border:1px solid #ddd;padding:12px;text-align:center;}
th{background:#4facfe;color:white;}
button{padding:6px 12px;border:none;background:#4facfe;color:white;font-size:14px;border-radius:6px;cursor:pointer;transition:0.3s;}
button:hover{background:#007bff;}
.data-table-container{margin-top:15px;}
.download-btn{background:#28a745;margin-bottom:10px;}
.download-btn:hover{background:#218838;}
</style>
</head>
<body>

<a href="form.html" class="top-btn">Go to Registration Page</a>
<h1>Admin - Manage Events</h1>

<div class="filter-section">
<label for="filterDate">Filter Events by Date: </label>
<input type="date" id="filterDate" onchange="displayEvents()">
<button onclick="clearFilter()">Clear Filter</button>
</div>

<div class="create-section">
<input type="text" id="eventName" placeholder="Event Name">
<input type="date" id="eventDate">
<button onclick="addEvent()">Add Event</button>
</div>

<div class="container">
<table>
<thead>
<tr><th>Event Name</th><th>Event Date</th><th>Actions</th></tr>
</thead>
<tbody id="eventTable"></tbody>
</table>
</div>

<script>
const WEB_APP_URL = "YOUR_WEB_APP_URL"; // Replace with your Google Web App URL

async function getEvents(){
  const res = await fetch(`${WEB_APP_URL}?sheet=Events`);
  return await res.json();
}

async function getRegistrations(){
  const res = await fetch(`${WEB_APP_URL}?sheet=Registrations`);
  return await res.json();
}

async function addEvent(){
  const name=document.getElementById("eventName").value.trim();
  const date=document.getElementById("eventDate").value;
  if(!name||!date){ alert("Enter Event Name & Date"); return; }
  await fetch(WEB_APP_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sheet:"Events",Name:name,Date:date})});
  document.getElementById("eventName").value="";
  document.getElementById("eventDate").value="";
  displayEvents();
}

async function editEvent(index){
  const events = await getEvents();
  const newName = prompt("Edit Event Name:", events[index].Name);
  const newDate = prompt("Edit Event Date:", events[index].Date);
  if(newName && newDate){
    // Delete old row
    // Add new row with new data
    alert("Currently, editing requires manual update in sheet.");
    displayEvents();
  }
}

async function deleteEvent(index){
  alert("Deleting requires manual update in sheet. Sheets API needed for full edit/delete.");
  displayEvents();
}

async function displayEvents(){
  const events = await getEvents();
  const table=document.getElementById("eventTable");
  table.innerHTML="";
  const filterDate = document.getElementById("filterDate").value;
  events.forEach((event,idx)=>{
    if(filterDate && event.Date!==filterDate) return;
    const row = document.createElement("tr");
    row.innerHTML=`<td>${event.Name}</td><td>${event.Date}</td>
    <td>
    <button onclick="showRegistrations(${idx},this)">Show Registrations</button>
    </td>`;
    table.appendChild(row);
  });
}

async function showRegistrations(eventIndex,btn){
  const existing=btn.closest("tr").nextElementSibling;
  if(existing && existing.classList.contains("data-row")) { existing.remove(); return; }
  const regs = await getRegistrations();
  const filtered = regs.filter(r=>r.EventIndex==eventIndex);
  const events = await getEvents();
  const eventName = events[eventIndex].Name;

  const row = document.createElement("tr");
  row.classList.add("data-row");
  let tableHTML=`<td colspan="3">
  <div class="data-table-container">
  <h3>${eventName} - Total Registrations: ${filtered.length}</h3>
  <button class="download-btn" onclick="downloadCSV('${eventName}',${eventIndex})">Download Excel</button>
  <table border="1" style="width:100%;border-collapse:collapse;">
  <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Gender</th><th>Race</th><th>DOB</th></tr></thead>
  <tbody>${filtered.map(r=>`<tr><td>${r.Name}</td><td>${r.Email}</td><td>${r.Phone}</td><td>${r.Gender}</td><td>${r.Race}</td><td>${r.DOB}</td></tr>`).join("")}</tbody>
  </table></div></td>`;
  row.innerHTML = tableHTML;
  btn.closest("tr").after(row);
}

function clearFilter(){ document.getElementById("filterDate").value=""; displayEvents(); }

function downloadCSV(eventName,eventIndex){
  const regs = JSON.parse(localStorage.getItem("registrations")||"[]").filter(r=>r.EventIndex==eventIndex);
  if(!regs.length){ alert("No data"); return; }
  const header=["Name","Email","Phone","Gender","Race","DOB"];
  const rows=regs.map(r=>[r.Name,r.Email,r.Phone,r.Gender,r.Race,r.DOB]);
  const csvContent=[header,...rows].map(e=>e.join(",")).join("\n");
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=`${eventName}.csv`;
  link.click();
}

displayEvents();
</script>
</body>
</html>
